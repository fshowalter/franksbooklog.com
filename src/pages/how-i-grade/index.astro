---
import { getCollection } from "astro:content";

import { getContentPlainText, getPage } from "~/api/pages";
import AstroPageShell from "~/astro/AstroPageShell.astro";
import { Article } from "~/components/article/Article";
import { getArticleProps } from "~/components/article/getArticleProps";
import { getLayoutBackdropImageProps } from "~/components/layout/getLayoutBackdropImageProps";
import { Layout } from "~/components/layout/Layout";

const pagesCollection = await getCollection("pages");
const pagesData = pagesCollection.map((e) => e.data);
const [worksEntries, reviewsEntries, authorsEntries, readingsEntries] =
  await Promise.all([
    getCollection("works"),
    getCollection("reviews"),
    getCollection("authors"),
    getCollection("readings"),
  ]);
const worksData = worksEntries.map((e) => e.data);
const reviewsData = reviewsEntries.map((e) => e.data);
const authorsData = authorsEntries.map((e) => e.data);
const readingsData = readingsEntries.map((e) => e.data);

const page = getPage("how-i-grade", pagesData, reviewsData)!;
const { body, content, title } = page;

const deck = `"I want you to hit me as hard as you can."`;

const props = await getArticleProps({
  authors: authorsData,
  content,
  readings: readingsData,
  reviews: reviewsData,
  works: worksData,
});

const contextPlainText = getContentPlainText(body);
const backdropImageProps = await getLayoutBackdropImageProps("how-i-grade");

//trim the string to the maximum length
var description = contextPlainText
  .replaceAll(/\r?\n|\r/g, " ")
  .slice(0, Math.max(0, 160));

//re-trim if we are in the middle of a word
description = description.slice(
  0,
  Math.max(0, Math.min(description.length, description.lastIndexOf(" "))),
);
---

<AstroPageShell
  canonical={true}
  meta={{ description }}
  openGraph={{ description: deck, type: "article" }}
  title={title}
>
  <Layout
    backdrop={{
      backdropImageProps,
      centerText: true,
      deck,
      size: "large",
      title,
    }}
    data-pagefind-body
  >
    <Article {...props} />
  </Layout>
</AstroPageShell>
