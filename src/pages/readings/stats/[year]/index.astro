---
import { getCollection } from "astro:content";

import { allStatYears } from "~/api/stats";
import AstroPageShell from "~/astro/AstroPageShell.astro";
import { getLayoutBackdropImageProps } from "~/components/layout/getLayoutBackdropImageProps";
import { Layout } from "~/components/layout/Layout";
import { getYearStatsProps } from "~/features/stats/getStatsProps";
import { YearStats } from "~/features/stats/YearStats";

interface Props {
  year: string;
}

export async function getStaticPaths() {
  const yearStatsEntries = await getCollection("yearStats");
  const yearStats = yearStatsEntries.map((e) => e.data);
  const statYears = allStatYears(yearStats);

  return statYears.map((year) => {
    return {
      params: {
        year: year,
      },
      props: {
        year: year,
      },
    };
  });
}

const { year } = Astro.props;

const yearStatsEntries = await getCollection("yearStats");
const yearStats = yearStatsEntries.map((e) => e.data);

const yearStatsProps = await getYearStatsProps(year, yearStats);
const backdropImageProps = await getLayoutBackdropImageProps("stats");
const distinctStatYears = allStatYears(yearStats);

const deck =
  [...distinctStatYears].reverse()[0] === year
    ? "A year in progress..."
    : "A Year in Review";

const metaDescription = `My ${year} reading stats. Includes my most-read authors; as well as kind, year published, and edition distributions.`;
---

<AstroPageShell
  canonical={true}
  meta={{
    description: metaDescription,
  }}
  openGraph={{
    description: deck,
    type: "website",
  }}
  title={`${year} Stats`}
>
  <Layout
    backdrop={{
      backdropImageProps,
      breadcrumb: {
        href: "/readings/",
        text: "Reading Log",
      },
      centerText: true,
      deck,
      title: `${year} Stats`,
    }}
  >
    <YearStats {...yearStatsProps} />
  </Layout>
</AstroPageShell>
