## 2026-02-23 - Spec Plan Stage 1: Rename fields in readings/reviews; update stats schemas

### What was implemented
- Updated `src/content.config.ts` — `ReadingSchema`:
  - Renamed `work_slug: reference("reviewedWorks")` → `workSlug: z.string()` (plain string, no longer a reference)
  - Renamed `edition_notes` → `editionNotes`
  - Added `slug: z.string()` field (unique reading ID = filename stem)
  - Added `date: z.coerce.date()` field
  - Updated AIDEV-NOTE comment
- Updated `src/content.config.ts` — `readings` loader `buildData`:
  - `frontmatter.edition_notes` → `frontmatter.editionNotes`
  - `frontmatter.work_slug` → `frontmatter.workSlug`
  - Added `slug: frontmatter.slug as string`
  - Added `date: frontmatter.date`
- Updated `src/content.config.ts` — `ReviewSchema`:
  - Renamed `work_slug: reference("reviewedWorks")` → `slug: reference("reviewedWorks")`
- Updated `src/content.config.ts` — `reviews` loader `buildData`:
  - `frontmatter.work_slug as string` → `frontmatter.slug as string`
  - Field key `work_slug:` → `slug:`
- Updated `src/content.config.ts` — `MostReadAuthorSchema`:
  - Removed `MostReadAuthorReadingSchema` entirely
  - Changed `readings: z.array(MostReadAuthorReadingSchema)` → `readings: z.array(reference("readings"))`
- Updated `src/api/reviews.ts`:
  - `reviews.find((r) => r.work_slug.id === work.slug)` → `r.slug.id`
  - `readings.find((r) => r.work_slug.id === review.slug)` → `r.workSlug === review.slug`
  - Updated AIDEV-NOTE comments
- Updated `src/features/review/getReviewProps.ts`:
  - `reviews.find((r) => r.work_slug.id === ref.id)` → `r.slug.id`
- Updated `src/features/stats/getStatsProps.ts`:
  - Added `buildStatsMaps()` helper — fetches `readings` and `reviewedWorks` collections, builds lookup maps
  - `createMostReadAuthorsListItemValueProps` now takes `readingsMap` and `worksMap`
  - Resolves each reading ref via `readingsMap.get(ref.id)!`, derives title/reviewed from `worksMap`
  - Cover image uses `{ slug: reading.workSlug }` instead of old embedded `reading.slug`
  - Date uses `reading.date` (Date object) instead of old embedded `reading.date` (string)
- Updated `src/features/stats/MostReadAuthors.tsx`:
  - Removed `readingSequence: number` from `ReadingSubListItemValue` type
  - Changed React key from `reading.readingSequence` to `reading.slug` (work slug)
- Updated `src/api/__fixtures__/readings.ts`:
  - `work_slug: { collection, id }` → `workSlug: "..."` (plain string)
  - `edition_notes: undefined` → `editionNotes: undefined`
  - Added `slug: "..."` (unique reading ID)
  - Added `date: new Date(...)`
- Updated `src/api/__fixtures__/reviews.ts`:
  - `work_slug: { collection, id }` → `slug: { collection, id }` (field renamed, still a reference)
  - Reordered fields alphabetically

### Files changed
- `src/content.config.ts` (updated)
- `src/api/reviews.ts` (updated)
- `src/features/review/getReviewProps.ts` (updated)
- `src/features/stats/getStatsProps.ts` (updated)
- `src/features/stats/MostReadAuthors.tsx` (updated)
- `src/api/__fixtures__/readings.ts` (updated)
- `src/api/__fixtures__/reviews.ts` (updated)
- `.astro/data-store.json` (deleted to force rebuild)
- `plan.md` (Stage 1 status → In Progress)
- `progress.txt` (this file)

### Learnings for future iterations:
- **`MostReadAuthorReadingSchema` removal breaks `MostReadAuthors.tsx`** — removing the embedded reading schema means the component's `ReadingSubListItemValue` type must also change; `readingSequence` is no longer available, use `reading.slug` (work slug) as React key instead
- **Stats props need `reviewedWorks` too** — after removing embedded readings from stats JSON, `getStatsProps.ts` needs both `readings` (for edition/date) and `reviewedWorks` (for title/reviewed status); the spec diff was simplified
- **`MostReadAuthorReadingSchema.slug` was the WORK slug** — in the old stats JSON, each embedded reading had `slug` = work slug; in `ReadingData`, `slug` is the unique reading ID and `workSlug` is the work slug; don't confuse them
- **Reading frontmatter fields are already renamed in content files** — `workSlug:`, `editionNotes:`, `date:`, `slug:` are already in the `.md` files; just need to update the loader to read them
- **`review` frontmatter already uses `slug:` not `work_slug:`** — the review .md files already have the new frontmatter key

---

## 2026-02-24 - Spec/Plan refinement; Stages 2 & 3 confirmed complete; Stage 4 fully specified

### Current state

Stages 1, 2, 3 are fully implemented. Stage 4 is not started. `PLAN.md` and `SPEC.md`
have been updated to reflect this. `intermediate-plan.md` has been superseded by the
updated `PLAN.md` Stage 4 section.

### What was confirmed complete (Stages 2 & 3)

Verified by reading source files — no code changes needed, PLAN.md status updated:

- `src/content.config.ts` has `works`, `moreForReviewedWorks` collections; `authors`
  loader simplified (no `reviewedWorks` field); `reviewedWorks` collection is gone
- `ReviewSchema.slug` is now `reference("works")` (not `reference("reviewedWorks")`)
- `src/api/reviews.ts` uses join-based `allReviews(works, reviews, authors, readings)`
- `src/features/stats/getStatsProps.ts` resolves reading refs via `readingsMap`
- All pages (`getReviewsProps`, `getAuthorTitlesProps`, `getReviewProps`, etc.) use
  `getCollection('works')` + `getCollection('reviews')` + `getCollection('authors')` directly
- `src/api/__fixtures__/reviewedWorks.ts` exports `workDataFixtures: WorkData[]` (not
  `ReviewedWorkData`) — the fixture file was already renamed/updated in Stage 2/3

### Stage 4: What needs to be done

The `readingEntries` collection's source file (`reading-entries.json`) does not exist.
The collection returns empty, so the reading log page renders 0 entries. Stage 4 fixes this.

**Exactly 6 files to change** (confirmed by grep — no others):

| File | Action |
| --- | --- |
| `src/api/readings.ts` | Rewrite `allReadingEntries` — new 4-arg signature, expand timelines |
| `src/api/__fixtures__/readingEntries.ts` | Delete |
| `src/api/readings.spec.ts` | Rewrite — use existing fixtures, new test scenarios |
| `src/features/reading-log/getReadingLogProps.ts` | Update signature and call |
| `src/pages/readings/index.astro` | Fetch 4 collections instead of `readingEntries` |
| `src/content.config.ts` | Remove `ReadingEntryAuthorSchema`, `ReadingEntrySchema`, `readingEntries` collection, `ReadingEntryData` export |

**Call stack:**
```
src/pages/readings/index.astro  ← getCollection() calls happen here
  └── getReadingLogProps(readings, works, reviews, authors)
        └── allReadingEntries(readings, works, reviews, authors)  ← main computation
```

**New `allReadingEntries` signature:**
```ts
export function allReadingEntries(
  readings: ReadingData[],
  works: WorkData[],
  reviews: ReviewData[],
  authors: AuthorData[],
): ReadingEntries
```

**New `ReadingEntry` type** (module-level, replaces `type ReadingEntry = ReadingEntryData`):
```ts
type ReadingEntry = {
  authors: { name: string; slug: string; sortName: string }[];
  edition: string;
  kind: WorkData["kind"];
  progress: string;
  readingEntryDate: string;   // YYYY-MM-DD from timeline[i].date.toISOString().slice(0, 10)
  readingEntrySequence: number;
  reviewed: boolean;
  slug: string;               // work slug (reading.workSlug) — used by getFluidCoverImageProps
  title: string;
  workYear: string;
};
```

**Key computation notes:**
- Build: `authorsMap` (slug→AuthorData), `worksMap` (slug→WorkData), `reviewedSlugs` (Set of work slugs)
- `reviewedSlugs`: use `reviews.map(r => r.slug.id)` — `ReviewData.slug` is `{ collection, id }` not a plain string
- Sort key: `${dateStr}-${String(reading.sequence).padStart(3, "0")}` — `reading.sequence` not `reading.slug`
- `readingEntrySequence` = index + 1 after sort
- Drop `includedInSlugs` — not in `ReadingLogValue`, unused everywhere
- Remove module-level `yearFormatter` — replace with `readingEntryDate.slice(0, 4)`
- `RawEntry` type: use inline annotation `Array<{ entry: ReadingEntry; sortKey: string }>`, not `type` inside function
- `getReadingLogProps` only destructures 5 fields: `distinctEditions, distinctKinds, distinctReadingYears, distinctWorkYears, readingEntries` — count fields computed but not consumed by page

**Existing fixtures to use in `readings.spec.ts`:**
- `readingDataFixtures` from `__fixtures__/readings.ts` — dark-crusade (2 timeline entries), carrie (1)
- `workDataFixtures` from `__fixtures__/reviewedWorks.ts` — dark-crusade (Novel, 1976), carrie (Novel, 1974)
- `reviewDataFixtures` from `__fixtures__/reviews.ts` — both dark-crusade and carrie reviewed
- `authorFixtures` from `__fixtures__/authors.ts` — karl-edward-wagner, stephen-king

**Expected test output** (3 entries from 2 readings):
| seq | readingEntryDate | progress | slug |
| --- | --- | --- | --- |
| 1 | 2012-05-13 | 14% | dark-crusade-by-karl-edward-wagner |
| 2 | 2012-05-18 | Finished | dark-crusade-by-karl-edward-wagner |
| 3 | 2023-06-15 | Finished | carrie-by-stephen-king |
`workCount=2, bookCount=2, shortStoryCount=0, abandonedCount=0`
`distinctEditions=["First Edition","Trade Paperback"], distinctKinds=["Novel"]`
`distinctReadingYears=["2012","2023"], distinctWorkYears=["1974","1976"]`
Empty call: `allReadingEntries([], [], [], [])` → all counts 0

**Files NOT needing changes** (confirmed):
- `ReadingLog.spec.tsx` — uses `createReadingValue()` helper, independent of data layer
- `ReadingLog.tsx`, `filterReadingLog.ts`, `sortReadingLog.ts` — operate on `ReadingLogValue` only
- No readings page snapshot test exists (`src/pages/readings/` has no `.spec.ts`)

**Execution order:**
1. Rewrite `src/api/readings.ts`
2. Delete `src/api/__fixtures__/readingEntries.ts`
3. Rewrite `src/api/readings.spec.ts`
4. Update `src/features/reading-log/getReadingLogProps.ts`
5. Update `src/pages/readings/index.astro`
6. Remove `readingEntries` from `src/content.config.ts`
7. Delete `.astro/data-store.json`
8. `npm run check && npm run lint && npm run test -- --max-workers=2`
9. If snapshots fail: `npm run test:update`
10. `npm run build`
11. `npm run lint:spelling && npm run knip && npm run format`

---
