## 2026-02-22 - Stage 1: Create content.config.ts with all collections

### What was implemented
- Created `src/content.config.ts` with all 8 content collections using custom inline loaders:
  - `authors` — glob `/content/data/authors/*.json`, maps reviewedWorks to slug strings for reference()
  - `reviewedWorks` — reads `/content/data/reviewed-works.json`, strips embedded moreByAuthors[].reviewedWorks and moreReviews to slugs for reference()
  - `readingEntries` — reads `/content/data/reading-entries.json`, ID = String(readingEntrySequence)
  - `reviews` — glob `/content/reviews/*.md`, pre-computes intermediateHtml and excerptHtml via remark/rehype (without linkReviewedWorks)
  - `readings` — glob `/content/readings/*.md`, pre-computes intermediateReadingNotesHtml and intermediateEditionNotesHtml
  - `pages` — glob `/content/pages/*.md`, pre-computes intermediateHtml
  - `alltimeStats` — reads `/content/data/all-time-stats.json` as single entry with id "alltime"
  - `yearStats` — glob `/content/data/year-stats/*.json`, ID = year string

- Exported all 8 `z.infer<>` types (AlltimeStatData, AuthorData, PageData, ReadingData, ReadingEntryData, ReviewData, ReviewedWorkData, YearStatData)
- All loaders use the `sync` pattern for HMR watcher callbacks
- Digest-based caching for skip-if-unchanged optimization in markdown loaders
- Selective entry removal (not store.clear()) to preserve cache efficiency

### Files changed
- `src/content.config.ts` (created)
- `PLAN.md` (Stage 1 status → Complete, success criteria checked)
- `progress.txt` (this file)

### Missing permissions
- None

### Learnings for future iterations:
- **`ctx.load(ctx)` does NOT exist on LoaderContext** — the correct HMR pattern is to define a local `sync()` function inside `load()`, call `await sync()` for initial load, then register `ctx.watcher?.on("change", () => void sync())` for HMR. The `sync` function captures `ctx` in its closure.
- **Astro LoaderContext API**: `ctx.store.has(id)`, `ctx.store.get(id)?.digest`, `ctx.store.set({ id, data, digest })`, `ctx.store.delete(id)`, `ctx.store.keys()` (returns Array<string>), `ctx.parseData({ id, data })`, `ctx.generateDigest(record)`, `ctx.watcher` (FSWatcher, dev-only)
- **Auto-fix catches most lint issues**: `npx eslint --fix` fixed 18 of 19 errors automatically (imports reordering, sort-modules, sort-object-types, utf-8→utf8, array types, intersection types, union types). Only `unicorn/no-null` needed manual fix (change `editionNotes ?? null` to `editionNotes`)
- **`perfectionist/sort-imports`**: `astro:content` is value-external and must come BEFORE `~/api/*` (value-internal) imports
- **`perfectionist/sort-modules`**: type declarations must come before function declarations in module scope; both groups sorted alphabetically
- **`unicorn/text-encoding-identifier-case`**: Use `"utf8"` not `"utf-8"` in fs.readFile calls
- **`unicorn/no-null`**: Don't use null literal values; pass nullable frontmatter fields directly rather than using `?? null`
- **`@typescript-eslint/array-type`**: Use `T[]` not `Array<T>`
- **`perfectionist/sort-intersection-types`**: Sort intersection type members alphabetically (Record<...> before { ... } object literals)
- **Build is production-verified**: `npm run build` completes successfully (161 pages) with all collections loading correctly
- **All 279 existing tests pass** — no test changes needed for Stage 1
- **Object keys in object type literals**: `[key: string]` index signature sorts before named properties (ESLint auto-fixed this)
- **Digest-based skip is important for performance**: markdown loaders process 89 reviews and 198 readings through remark/rehype — the digest check prevents re-processing unchanged files on incremental builds

---

## 2026-02-22 - Stage 2: Migrate `pages.ts`

### What was implemented
- Updated `src/api/pages.ts` to a pure synchronous function:
  - `getPage(slug, pages: PageData[], reviewedWorks: ReviewedWorkData[])` — no longer async, no I/O or caching
  - Applies `linkReviewedWorks(page.intermediateHtml, reviewedWorks)` to produce final HTML
  - `getContentPlainText` utility remains unchanged
  - Removed `allPagesMarkdown`, `allReviewedWorksJson`, `ENABLE_CACHE`, `perfLogger`, `getHtml` imports
- Updated `src/pages/how-i-grade/index.astro` to call `getCollection('pages')` and `getCollection('reviewedWorks')`, pass data to `getPage`; `rawContent` renamed to `body`
- Created `src/api/__fixtures__/pages.ts` — `PageData[]` fixture with `intermediateHtml` containing linked/unlinked work spans
- Created `src/api/__fixtures__/reviewedWorks.ts` — minimal `ReviewedWorkData[]` fixture (slug "linked-work")
- Created `src/api/pages.spec.ts` — 7 pure function tests for `getPage` and `getContentPlainText`
- Deleted `src/api/data/pages-markdown.ts`
- Deleted snapshot tests: `src/pages/how-i-grade/_index.spec.ts`, `_og.spec.ts`, `__snapshots__/index.html`, `__image_snapshots__/og.jpg`

### Files changed
- `src/api/pages.ts` (updated)
- `src/pages/how-i-grade/index.astro` (updated)
- `src/api/__fixtures__/pages.ts` (created)
- `src/api/__fixtures__/reviewedWorks.ts` (created)
- `src/api/pages.spec.ts` (created)
- `src/api/data/pages-markdown.ts` (deleted)
- `src/pages/how-i-grade/_index.spec.ts` (deleted)
- `src/pages/how-i-grade/_og.spec.ts` (deleted)
- `src/pages/how-i-grade/__snapshots__/index.html` (deleted)
- `src/pages/how-i-grade/__image_snapshots__/og.jpg` (deleted)
- `PLAN.md` (Stage 2 status → Complete, success criteria checked)
- `progress.txt` (this file)

### Missing permissions
- None

### Learnings for future iterations:
- **`unicorn/no-await-expression-member`**: Cannot write `(await getCollection(...)).map(...)` — must store the awaited result in a variable first, then call `.map()` on it
- **`perfectionist/sort-imports` in spec files**: Fixture imports (`./__fixtures__/`) sort before the module under test (`./pages`) because `_` precedes lowercase letters alphabetically
- **`ReviewedWorkData` fixture shape**: All fields from the schema transform must be present including `notes: undefined` on author entries and `subtitle: undefined` on works; `moreReviews` and `moreByAuthors[].reviewedWorks` are `Array<{ collection: string; id: string }>` not string arrays (post-parseData reference shape)
- **Return type of new `getPage`**: `(PageData & { content: string }) | undefined` — callers use `!` assertion when slug is known to exist; `body` field replaces old `rawContent` field name
- **Prettier pre-existing issues**: `content.config.ts`, `PLAN.md`, `SPEC.md` already had formatting issues from Stage 1 — fixed in this stage

---
